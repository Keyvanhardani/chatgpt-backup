<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ChatGPT Backup Tool</title>
    <link
      href="https://unpkg.com/primevue/resources/themes/lara-light-indigo/theme.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/primevue/resources/primevue.min.css"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/primeicons/primeicons.css" rel="stylesheet" />

    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://unpkg.com/primevue/api/api.min.js"></script>
    <script src="https://unpkg.com/primevue/config/config.min.js"></script>
    <script src="https://unpkg.com/primevue/utils/utils.min.js"></script>
    <script src="https://unpkg.com/primevue/virtualscroller/virtualscroller.min.js"></script>

    <script src="https://unpkg.com/primevue/ripple/ripple.min.js"></script>
    <script src="https://unpkg.com/primevue/columngroup/columngroup.min.js"></script>
    <script src="https://unpkg.com/primevue/paginator/paginator.min.js"></script>
    <script src="https://unpkg.com/primevue/column/column.min.js"></script>
    <script src="https://unpkg.com/primevue/datatable/datatable.min.js"></script>
    <script src="https://unpkg.com/primevue/inputtext/inputtext.min.js"></script>
    <script src="https://unpkg.com/primevue/button/button.min.js"></script>
    <script src="https://unpkg.com/primevue/dialog/dialog.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      .column-td {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .column-td .button-container {
        display: flex;
        justify-content: flex-end;
      }

      .column-td button {
        margin-left: 5px;
      }

      body,
      html {
        height: 100%;
        margin: 0;
      }

      .app-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
      }

      .content-container {
        display: flex;
        width: 100%;
        max-width: 1400px;
        height: 100%;
      }

      .table-container {
        flex: 1;
        min-width: 0;
        height: 100%;
        overflow-y: auto;
      }

      .preview {
        flex: 1;
        position: sticky;
        top: 0;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 1rem;
        height: 100%;
      }

      .preview pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .preview code {
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .splash-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 2rem;
        text-align: center;
      }

      .splash-container h1 {
        margin-bottom: 2rem;
      }

      .splash-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      .file-info {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #666;
      }
    </style>
  </head>

  <body>
    <div id="app" class="app-container"></div>

    <template id="template">
      <div v-if="!output" class="splash-container">
        <h1>ChatGPT Backup Tool</h1>
        <p>Choose an option to get started:</p>
        <div class="splash-buttons">
          <p-button label="Create New Backup" icon="pi pi-download" class="p-button-primary" @click="startBackup"></p-button>
          <p-button label="Load Existing Backup" icon="pi pi-upload" @click="openFileSelector"></p-button>
        </div>
        <input type="file" id="fileInput" @change="loadJSON" accept=".json" style="display: none;" />
        <div v-if="selectedFile" class="file-info">
          Selected file: {{ selectedFile.name }}
        </div>
      </div>

      <p-dialog v-model:visible="showBackupDialog" header="Configure Backup" modal style="width: 30vw">
        <div class="backup-config">
          <p>Customize your backup parameters:</p>
          <div class="p-field">
            <label for="startOffset">Start Offset</label>
            <p-inputtext id="startOffset" v-model.number="backupConfig.startOffset" type="number" min="0" />
          </div>
          <div class="p-field">
            <label for="stopOffset">Stop Offset (set to -1 for all messages)</label>
            <p-inputtext id="stopOffset" v-model.number="backupConfig.stopOffset" type="number" min="-1" />
          </div>
        </div>
        <template #footer>
          <p-button label="Cancel" icon="pi pi-times" @click="showBackupDialog = false" class="p-button-text"></p-button>
          <p-button label="Start Backup" icon="pi pi-check" @click="runBackup" autofocus></p-button>
        </template>
      </p-dialog>

      <div v-if="output" class="content-container">
        <div class="table-container">
          <div style="margin-bottom: 1rem; padding: 0.5rem;">
            <p-button icon="pi pi-arrow-left" label="Back" @click="resetApp" style="margin-right: 0.5rem;"></p-button>
            <span v-if="backupFileName">Current backup: {{ backupFileName }}</span>
          </div>
          <p-datatable :value="output">
            <p-column field="title" header="Title" class="column-td">
              <template #body="slotProps">
                <span>{{ slotProps.data.title || 'Untitled' }}</span>
                <div class="button-container">
                  <p-button
                    icon="pi pi-eye"
                    size="small"
                    @click="showPreview(slotProps.data)"
                  ></p-button>
                  <p-button
                    icon="pi pi-download"
                    size="small"
                    @click="downloadChat(slotProps.data)"
                  ></p-button>
                </div>
              </template>
            </p-column>
          </p-datatable>
        </div>
        <div class="preview" v-if="selectedChat" v-html="preview"></div>
      </div>
    </template>
    <script>
      const app = Vue.createApp({
        data() {
          return {
            output: null,
            preview: '',
            selectedChat: false,
            previousChat: null,
            showBackupDialog: false,
            selectedFile: null,
            backupFileName: '',
            backupConfig: {
              startOffset: 0,
              stopOffset: 20
            }
          };
        },
        methods: {
          openFileSelector() {
            document.getElementById('fileInput').click();
          },
          resetApp() {
            this.output = null;
            this.preview = '';
            this.selectedChat = false;
            this.previousChat = null;
            this.selectedFile = null;
            this.backupFileName = '';
          },
          startBackup() {
            this.showBackupDialog = true;
          },
          runBackup() {
            this.showBackupDialog = false;
            // Load the backup.js script dynamically
            const script = document.createElement('script');
            script.src = 'backup.js';
            script.onload = () => {
              // Call the main function from backup.js with our parameters
              window.runBackup(this.backupConfig.startOffset, this.backupConfig.stopOffset);
            };
            document.body.appendChild(script);
          },
          loadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            this.selectedFile = file;
            this.backupFileName = file.name;
            
            const reader = new FileReader();
            reader.readAsText(file);
            reader.onload = () => {
              try {
                const json = JSON.parse(reader.result);
                this.output = json;
                localStorage.setItem('json_data', JSON.stringify(json));
                localStorage.setItem('backup_filename', file.name);
              } catch (error) {
                alert('Error parsing JSON file: ' + error.message);
              }
            };
          },
          jsonToMarkdown(json) {
            let output = '';
            const userIcon = '![User](assets/mdi-user.png)';
            const assistantIcon =
              '![Assistant](assets/tabler-brand-openai-1.png)';
            for (const message of json.messages) {
              if (message.role === 'user' || message.role === 'assistant') {
                output += `${
                  message.role === 'user' ? userIcon : assistantIcon
                }\r\n\r\n${message.content[0]}\n\n---\n\n`;
              }
            }
            return output;
          },
          downloadChat(chat) {
            const title = chat.title || 'Untitled';
            const markdown = this.jsonToMarkdown(chat);
            this.downloadMarkdown(title, markdown);
          },
          downloadMarkdown(title, markdown) {
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${title}.md`;
            link.click();
            URL.revokeObjectURL(url);
          },
          showPreview(chat) {
            this.selectedChat =
              !this.selectedChat || this.previousChat !== chat;
            this.previousChat = chat;
            const markdown = this.jsonToMarkdown(chat);
            const outputElement = document.createElement('div');
            outputElement.innerHTML = marked.parse(markdown);
            this.preview = outputElement.innerHTML;
          },
        },
        mounted() {
          const savedJSON = localStorage.getItem('json_data');
          const savedFilename = localStorage.getItem('backup_filename');
          
          if (savedJSON) {
            this.output = JSON.parse(savedJSON);
            this.backupFileName = savedFilename || '';
          }
        },
        template: '#template',
        components: {
          'p-button': primevue.button,
          'p-datatable': primevue.datatable,
          'p-column': primevue.column,
          'p-dialog': primevue.dialog,
          'p-inputtext': primevue.inputtext,
        },
      });
      app.directive('ripple', primevue.ripple);
      app.mount('#app');
    </script>
  </body>
</html>
